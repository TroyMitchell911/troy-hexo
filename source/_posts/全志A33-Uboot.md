title: '[全志A33]Uboot'
date: '2024-09-13 10:58:32'
updated: '2024-09-13 10:58:34'
tags:
  - uboot
categories:
  - uboot
---
## Env

cpu: allwinner a33
board: vstart
host: ubuntu 22.04

## uboot-sunxi仓库试错

**该章节并没有成功，所以如果想学习可以看看，只是想移植uboot就可以跳到下一个章节**

要移植uboot首先想到的肯定是全志的uboot仓库，先拉下来代码：

```bash
❯ git clone https://github.com/linux-sunxi/u-boot-sunxi 
❯ cd u-boot-sunxi 
```

使用一个A33芯片的板子的config进行配置并编译，经过测试, A33-OLinuXino_defconfig这个配置文件没支持emmc，只支持了sd，这里选择sinlinx的config，与vstar开发板相近：

```bash
❯ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- Sinlinx_SinA33_defconfig
❯ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16
```

编译遇到如下错误，看起来很熟悉，好像当年搞f1c200s的时候也遇见了这个错误...

给lichee pi的仓库提交了pr，但已经过去了一年多，也没有理我...

该错误可通过该pr修复：[我是PR](https://github.com/Lichee-Pi/u-boot/pull/7)

```bash
usr/bin/ld: scripts/dtc/dtc-parser.tab.o:(.bss+0x10): multiple definition of `yylloc'; scripts/dtc/dtc-lexer.lex.o:(.bss+0x0): first defined here
  UPD     include/generated/version_autogenerated.h
  CC      lib/asm-offsets.s
  CC      arch/arm/lib/asm-offsets.s
collect2: error: ld returned 1 exit status
make[2]: *** [scripts/Makefile.host:106：scripts/dtc/dtc] 错误 1
make[2]: *** 正在等待未完成的任务....
```

继续编译，到了最后阶段却遇到了如下错误：

```bash
  MKSUNXI spl/sunxi-spl.bin
  BINMAN  u-boot-sunxi-with-spl.bin
binman: No module named _libfdt
make: *** [Makefile:1348：u-boot-sunxi-with-spl.bin] 错误 1
```

检查python是否有这个module:

```bash
❯ python -m pip list | grep pylibfdt
pylibfdt                           1.7.0.post1
```

这时候已经开始怀疑是这个module的版本问题了，在[这里](https://pypi.org/project/pylibfdt/#history)找到了历史版本信息，逐个尝试安装还是不行...

最终在[这里](https://lore.kernel.org/buildroot/bug-11706-163@https.bugs.busybox.net%2F/T/)找到了问题的原因，是python版本的问题。

在[这里](https://blog.csdn.net/qq_34752070/article/details/125182978)找到了问题的解决方案，重新链接后解决问题。

连接开发板串口0之后通过进入fel启动uboot：

```bash
❯ git clone git@github.com:u-boot/u-boot.git
❯ sudo sunxi-fel uboot ./u-boot-sunxi-with-spl.bin
```

之后发现emmc和sd卡都无法使用...

```bash
=> mmc dev 0
Card did not respond to voltage select!
=> mmc dev 1
Card did not respond to voltage select!
=> mmc dev 0
MMC: no card present
=> mmc dev 1
Card did not respond to voltage select!
```

**fuck you allwinner! mainline start!**

## mainline

拉取uboot主线代码：

```bash
❯ git clone git@github.com:u-boot/u-boot.git 
❯ cd u-boot
```

依旧使用之前的Sinlinx的配置：

```bash
❯ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- Sinlinx_SinA33_defconfig
❯ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16
```

这次发现日志到MMC就结束了：

```bash
U-Boot 2024.10-rc4-g5f0449324136-dirty (Sep 14 2024 - 15:47:46 +0800) Allwinner Technology

CPU:   Allwinner A33 (SUN8I 1667)
Model: Sinlinx SinA33
DRAM:  512 MiB
Core:  64 devices, 21 uclasses, devicetree: separate
WDT:   Not starting watchdog@1c20ca0
MMC: 
```

这里一开始一直怀疑uboot卡死了，排查一段时间后发现其实并不是。

可以观察到`Model: Sinlinx SinA33`这一行，按找这个查找对应设备树：

```bash
❯ find -name "*.dts*" -exec grep -n "Sinlinx SinA33" {} +
./arch/arm/dts/sun8i-a33-sinlinx-sina33.dts:53:	model = "Sinlinx SinA33";
./dts/upstream/src/arm/allwinner/sun8i-a33-sinlinx-sina33.dts:53:	model = "Sinlinx SinA33";
```

查到两个dts，查询dtb:

```bash
❯ ls ./arch/arm/dts/sun8i-a33-sinlinx-sina33.dtb
./arch/arm/dts/sun8i-a33-sinlinx-sina33.dtb
❯ ls ./dts/upstream/src/arm/allwinner/sun8i-a33-sinlinx-sina33.dtb
ls: 无法访问 './dts/upstream/src/arm/allwinner/sun8i-a33-sinlinx-sina33.dtb': 没有那个文件或目录
```

可以确定就是`./arch/arm/dts/sun8i-a33-sinlinx-sina33.dtb`这个文件，查询其对应的dts可以发现指定的就是uart0：

```bash
	aliases {
		serial0 = &uart0;
	};

	chosen {
		stdout-path = "serial0:115200n8";
	};
```

查看uart0节点及其对应的gpio：

```bash
// ./arch/arm/dts/sun8i-a33-sinlinx-sina33.dts
&uart0 {
	pinctrl-names = "default";
	pinctrl-0 = <&uart0_pb_pins>;
	status = "okay";
};

//./arch/arm/dts/sun8i-a33.dtsi
&pio {
	compatible = "allwinner,sun8i-a33-pinctrl";
	interrupts = <GIC_SPI 15 IRQ_TYPE_LEVEL_HIGH>,
		     <GIC_SPI 17 IRQ_TYPE_LEVEL_HIGH>;

	uart0_pb_pins: uart0-pb-pins {
		pins = "PB0", "PB1";
		function = "uart0";
	};
};
```

这里指定了uart0的引脚使用PB0作tx，PB1作rx，查看原理图这两个引脚原来在是uart2,将uart2的引脚复用成uart0了

