title: rk3568移植主线内核
date: '2024-09-03 16:09:32'
updated: '2024-09-03 16:09:33'
tags:
  - rk3568
  - kernel
  - linux
  - rockchip
categories:
  - kernel
  - rockchip
---
## Env

Board: Lubancat-2io

这篇文章需要用到之前移植的[uboot](https://blog.505218.xyz/2024/08/26/rk3568%E7%A7%BB%E6%A4%8Duboot-1/)和[extlinux](https://blog.505218.xyz/2024/08/26/%E9%87%8E%E7%81%ABuboot%E4%BD%BF%E7%94%A8extboot%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8%E6%B5%81%E7%A8%8B/)的基础知识。

## Get source

```bash
❯ git clone git@github.com:torvalds/linux.git 
```

查看一下`dts`的内容：

```bash
❯ ls arch/arm64/boot/dts/rockchip/rk3568* | grep lubancat
arch/arm64/boot/dts/rockchip/rk3568-lubancat-2.dts
```

主线是有`lubancat-2`的设备树的，这就很大的方便了我们，可以稍作修改设备树即可完美在`2io`上全适配。

## 内核config配置

```bash
❯ ls arch/arm64/configs
defconfig  hardening.config   virt.config
```

这里并没有`rk3568 evb`板子的配置文件，所以我们就先使用`defconfig`就好，遇到什么问题再解决什么问题。

```bash
❯ make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
❯ make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j32
❯ ls arch/arm64/boot/dts/rockchip/rk3568-lubancat-2.dtb
arch/arm64/boot/dts/rockchip/rk3568-lubancat-2.dtb
❯ ls arch/arm64/boot/Image
arch/arm64/boot/Image
```

依据[extlinux](https://blog.505218.xyz/2024/08/26/%E9%87%8E%E7%81%ABuboot%E4%BD%BF%E7%94%A8extboot%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8%E6%B5%81%E7%A8%8B/)的经验，有了内核和设备树之后，我们只需要`extlinux.conf`文件即可。

```bash
❯ mkdir -p extboot && cp arch/arm64/boot/dts/rockchip/rk3568-lubancat-2.dtb extboot && cp arch/arm64/boot/Image-master
❯ mkdir -p extboot/extlinux/extlinux.conf
```

在`extboot/extlinux/extlinux.conf`文件中写入如下内容：

```bash
label rockchip-master
    kernel /Image-master
    fdt /rk3568-lubancat-2.dtb
    append root=dev/mmcblk0p3 earlyprintk console=ttyFIQ0 console=tty1 consoleblank=0 loglevel=7 rootwait rw rootfstype=ext4 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory swapaccount=1 switolb=1 coherent_pool=1m
```

其中`append`的`bootargs`来自于`lubancat`的`extlinux.conf`，创建好之后查看一下目录文件结构：

```bash
❯ tree extboot
.
├── extlinux
│   ├── extlinux.conf
├── Image-master
├── rk3568-lubancat-2.dtb

1 directory, 3 files
```

一切无误后，就可以生成boot分区的镜像了，注意，这个操作不要在`extboot`文件夹下操作，否则就会递归：

```bash
❯ genext2fs -b 32768 -B $((64*1024*1024/32768)) -d ./extboot -i 8192 -U boot.img
```